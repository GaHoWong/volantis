<%- js('https://cdn.jsdelivr.net/npm/jquery@3.4/dist/jquery.min.js') %>
<%- js('https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js') %>

<% if (theme.search && theme.search.enable) { %>
    <script>
        <% if(theme.search.service === 'baidu') { %>
        var BAIDU_API_ID = "<%- theme.search.baidu.apiId %>";
        <% } else if(theme.search.service === 'algolia') { %>
        var ALGOLIA_API_KEY = "<%- theme.search.algolia.apiKey %>";
        var ALGOLIA_APP_ID = "<%- theme.search.algolia.applicationID %>";
        var ALGOLIA_INDEX_NAME = "<%- theme.search.algolia.indexName %>";
        <% } else if(theme.search.service === 'azure') { %>
        var AZURE_QUERY_KEY = "<%- theme.search.azure.queryKey %>";
        var AZURE_INDEX_NAME = "<%- theme.search.azure.indexName %>";
        var AZURE_SERVICE_NAME = "<%- theme.search.azure.serviceName %>";
        <% } else if(theme.search.service === 'google') { %>
        var GOOGLE_CUSTOM_SEARCH_API_KEY = "<%- theme.search.google.apiKey %>";
        var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "<%- theme.search.google.engineId %>";
        <% } %>
        var SEARCH_SERVICE = "<%- theme.search.service %>" || "hexo";
        var ROOT = "<%- config.root %>" || "/";
        if (!ROOT.endsWith('/')) ROOT += '/';
    </script>
<% } %>

<!--似乎不需要处理-->
<% if (theme.plugins.backstretch && theme.plugins.backstretch.enable && (theme.plugins.backstretch.images || page.images)) { %>
    <% var imgs = theme.plugins.backstretch.images || page.images; %>
    <% var posi = null;
        if (theme.plugins.backstretch.position == 'cover') {
            posi = '.cover';
        }
    %>
    <% if (imgs != undefined && theme.plugins.backstretch.position != undefined){ %>
        <%- js(theme.plugins.backstretch.js) %>
        <script type="text/javascript">
          $(function () {
            var imgs =<%- '["' + imgs.join('", "') + '"]' %>;
            if ('<%- theme.plugins.backstretch.shuffle %>' == 'true') {
              function shuffle(arr) {
                /*From countercurrent-time*/
                var n = arr.length;
                while (n--) {
                  var index = Math.floor(Math.random() * n);
                  var temp = arr[index];
                  arr[index] = arr[n];
                  arr[n] = temp;
                }
              }

              shuffle(imgs);
            }
            if ('<%- posi %>') {
              $('<%- posi %>').backstretch(
                imgs,
                {
                  duration: "<%- theme.plugins.backstretch.duration %>",
                  fade: "<%- theme.plugins.backstretch.fade %>"
                });
            } else {
              $.backstretch(
                imgs,
                {
                  duration: "<%- theme.plugins.backstretch.duration %>",
                  fade: "<%- theme.plugins.backstretch.fade %>"
                });
            }
          });
        </script>
    <% } %>
<% } %>

<!--似乎不需要处理-->
<% if (theme.plugins.aplayer && theme.plugins.aplayer.enable && theme.plugins.aplayer.js) { %>
    <% (theme.plugins.aplayer.js || []).forEach(function(item){ %>
        <%- js({src: item}) %>
    <% }) %>
<% } %>

<!-- valine -fix -->
<% if (theme.comments.valine.js) { %>
    <%- js(theme.comments.valine.js) %>
<% } else { %>
    <%- js(['js/valine.js']) %>
<% } %>
<script>
  var GUEST_INFO = ['nick', 'mail', 'link'];
  var meta = '<%= theme.comments.valine.meta %>'.split(',').filter(function (item) {
    return GUEST_INFO.indexOf(item) > -1
  });
  var REQUIRED_FIELDS = ['nick', 'mail', 'link'];
  var requiredFields = '<%= theme.comments.valine.requiredFields %>'.split(',').filter(function (item) {
    return REQUIRED_FIELDS.indexOf(item) > -1
  });

  function emoji(path, idx, ext) {
    return path + "/" + path + "-" + idx + "." + ext;
  }

  var emojiMaps = {};
  for (var i = 1; i <= 101; i++) {
    emojiMaps['qq-' + i] = emoji('qq', i, 'gif');
  }
  for (var i = 1; i <= 4; i++) {
    emojiMaps['weibo-' + i] = emoji('weibo', i, 'png');
  }

  function pjax_valine() {
    var valinePath = $.trim($('#valine-path').text()) === "none" ?
      window.location.pathname : $.trim($('#valine-path').text());

    var valinePlaceholder = $.trim($('#valine-placeholder').text()) === "none" ?
      "<%= theme.comments.valine.placeholder %>" : $.trim($('#valine-placeholder').text());

    var valine = new Valine();
    valine.init({
      el: '#valine_container',
      meta: meta,
      placeholder: valinePlaceholder,
      path: valinePath,
      appId: "<%= theme.comments.valine.appId %>",
      appKey: "<%= theme.comments.valine.appKey %>",
      pageSize: '<%= theme.comments.valine.pageSize %>',
      avatar: '<%= theme.comments.valine.avatar %>',
      lang: '<%= theme.comments.valine.lang %>',
      visitor: '<%= theme.comments.valine.visitor %>',
      highlight: '<%= theme.comments.valine.highlight %>',
      mathJax: '<%= theme.comments.valine.mathJax %>',
      enableQQ: '<%= theme.comments.valine.enableQQ %>',
      requiredFields: requiredFields,
      emojiCDN: 'https://cdn.jsdelivr.net/gh/xaoxuu/cdn-assets/emoji/valine/',
      emojiMaps: emojiMaps
    })
  }

  $(function () {
    pjax_valine();
  });
</script>
<!-- ================================== -->

<!-- 复制 -fix -->
<% if (theme.plugins.clipboard && (theme.style.body.highlight.copy_btn == true)) { %>
    <%- partial('_third-party/clipboard') %>
<% } %>
<!-- ================================== -->

<!--scrollreveal -fix -->
<% if (theme.plugins.scrollreveal && theme.plugins.scrollreveal.js) { %>
    <script src="<%- theme.plugins.scrollreveal.js %>"></script>
    <script type="text/javascript">
      function pjax_scrollrebeal() {
        ScrollReveal().reveal('.l_main .reveal', {
          distance: '<%- theme.plugins.scrollreveal.distance %>',
          duration: '<%- theme.plugins.scrollreveal.duration %>',
          interval: '<%- theme.plugins.scrollreveal.interval %>',
          scale: '<%- theme.plugins.scrollreveal.scale %>'
        });
      }

      $(function () {
        pjax_scrollrebeal();
      });
    </script>
<% } %>
<!-- ================================== -->

<!-- fancybox -fix -->
<% if (theme.plugins.fancybox) { %>
    <%- partial('_third-party/fancybox') %>
<% } %>
<!-- ================================== -->

<!-- lazyload -fix -->
<% if (config.lazyload.enable){ %>
    <%- partial('_third-party/lazyload') %>
<% } %>
<!-- ================================== -->

<!--俩主要的 JS 文件-->
<% if (config.use_cdn && theme.info.cdn && theme.info.cdn.js) { %>
    <%- js(theme.info.cdn.js) %>
<% } else { %>
    <%- js(['js/app.js']) %>
<% } %>

<!--fix-->
<% if (theme.search && theme.search.enable && theme.search.js) { %>
    <% if (theme.search.cdn) { %>
        <%- js(theme.info.cdn.js) %>
    <% } else { %>
        <%- js(['js/search.js']) %>
    <% } %>
<% } %>

<!--重新加载即可-->
<% if (theme.plugins.busuanzi) { %>
    <script src="<%- theme.plugins.busuanzi %>" data-pjax></script>
<% } %>

<!--无需处理-->
<% if (theme.plugins.nodewaves && theme.plugins.nodewaves.js) { %>
    <%- js({src: theme.plugins.nodewaves.js}) %>
    <script type="text/javascript">
      $(function () {
        Waves.attach('.flat-btn', ['waves-button']);
        Waves.attach('.float-btn', ['waves-button', 'waves-float']);
        Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
        Waves.attach('.flat-box', ['waves-block']);
        Waves.attach('.float-box', ['waves-block', 'waves-float']);
        Waves.attach('.waves-image');
        Waves.init();
      });
    </script>
<% } %>

<!--无需处理-->
<% if (theme.plugins.comment_typing) { %>
    <%- js(theme.plugins.comment_typing) %>
<% } %>

<!--暂未发现需要处理-->
<% if (theme.plugins.instant_page) { %>
    <script async src="<%- theme.plugins.instant_page %>" type="module" defer
            integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>
<% } %>

<!--暂未知 是否需要处理-->
<% if (config.highlight.enable != true) { %>
    <% if (theme.plugins.highlightjs && theme.plugins.highlightjs.js) { %>
        <%- js(theme.plugins.highlightjs.js) %>
        <script>hljs.initHighlightingOnLoad();</script>
    <% } %>
<% } %>

<% if (config.import && config.import.script){ %>
    <% (config.import.script || []).forEach(function(item){ %>
        <%- item %><% }) %>
<% } %>

<script>
  $(document).ready(function () {
    NProgress.done();
  });

  var HEXO_URL = "<%- config.url %>";
  var HEXO_PERMALINK = "<%- config.permalink %>";

  var pjax;
  document.addEventListener('DOMContentLoaded', function () {
    pjax = new Pjax({
      elements: 'a[href]:not([href^="#"]):not([href="javascript:void(0)"])',
      selectors: [
        "title",
        "meta[name=description]",
        "meta[name=keywords]",
        "#pjax-container"
      ],
      cacheBust: false,   // url 地址追加时间戳，用以避免浏览器缓存
      timeout: '5000'
    });
  });

  document.addEventListener('pjax:send', function () {
    NProgress.start();
    $('.l_header').removeClass('z_search-open'); // 关闭移动端激活的搜索框
    $('.l_header .switcher .s-search').removeClass('active'); // 关闭移动端激活的搜索框
    $('.wrapper').removeClass('sub'); // 跳转页面时关闭二级导航
    $.fancybox.close();    // 关闭弹窗，曾经有人提过个BUG，在查看图片时浏览器返回上一页后，弹窗无法关闭了
    $(window).unbind();    // 解绑
    $(document).unbind();  // 解绑
  });
  document.addEventListener('pjax:complete', function () {
    $('script[data-pjax], .pjax-reload script').each(function () {
      $(this).parent().append($(this).remove());
    });

    pjax_lazyload();
    pjax_scrollrebeal();
    pjax_fancybox();
    pjax_initCopyCode();
    pjax_valine();

    NProgress.done();
  });

  document.addEventListener('pjax:error', function () {
    NProgress.done();
    window.location.href = event.triggerElement.href;
  });

</script>